apiVersion: v1
kind: ConfigMap
metadata:
  name: istio-installer-scripts
data:
  install-istio.sh: |
    #!/bin/sh
    set -e

    # образ curlimages/curl уже содержит curl; добавим tar
    apk add --no-cache tar

    ISTIO_VERSION="{{ .Values.global.istio.version }}"
    DOWNLOAD_URL="{{ .Values.global.istio.downloadUrl }}"

    echo "=== Istio binary installer ==="
    echo "Version: ${ISTIO_VERSION}"
    echo "URL:     ${DOWNLOAD_URL}"

    # ── 1. скачиваем istioctl ──────────────────────────────────────────
    mkdir -p /tmp/istio-${ISTIO_VERSION} && cd /tmp/istio-${ISTIO_VERSION}
    curl -sSL "${DOWNLOAD_URL}" -o istioctl.tar.gz
    tar -xzf istioctl.tar.gz

    # если бинарь лежит внутри подпапки — достаём
    [ -f ./istioctl ] || mv istioctl-*/bin/istioctl ./ || {
      echo "❌ istioctl binary not found after extraction" >&2
      exit 1
    }
    chmod +x istioctl

    # ── 2. создаём нужные namespace'ы (если включены) ─────────────────
    {{- if .Values.istio.ingressgatewayEnabled }}
    kubectl get ns istio-ingress >/dev/null 2>&1 || kubectl create namespace istio-ingress
    {{- end }}
    {{- if .Values.istio.egressgatewayEnabled }}
    kubectl get ns istio-egress  >/dev/null 2>&1 || kubectl create namespace istio-egress
    {{- end }}

    # ── 3. устанавливаем Istio ────────────────────────────────────────
    ./istioctl install -f /manifests/istio-operator.yml -y

    # ── 4. дополнительные манифесты ───────────────────────────────────
    {{- if .Values.istio.ingressgatewayEnabled }}
    kubectl apply -f /manifests/istio-default-gateway.yml
    {{- end }}

    {{- if .Values.istio.prometheusScrape }}
    kubectl apply -f /manifests/istio-scrapping-sm.yml
    {{- end }}

    {{- if .Values.istio.cpuLimitsDisabled }}
    kubectl patch -f /manifests/istio-sidecar-injector.yaml \
                  --patch-file /manifests/istio-sidecar-injector.yaml
    {{- end }}

    # ── 5. рестарт istiod ─────────────────────────────────────────────
    kubectl rollout restart deployment/istiod -n istio-system
    kubectl rollout status deployment/istiod -n istio-system --timeout=300s

    echo "✅ Istio installation completed"
