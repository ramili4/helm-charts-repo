apiVersion: v1
kind: ConfigMap
metadata:
  name: istio-installer-scripts
data:
  install-istio.sh: |
    #!/bin/sh
    set -e
    ISTIO_VERSION="{{ .Values.global.istio.version | default .Chart.AppVersion }}"
    DOWNLOAD="{{ .Values.global.istio.downloadUrl }}"
    echo "Downloading istioctl $ISTIO_VERSION"
    curl -sSL "$DOWNLOAD/$ISTIO_VERSION/istioctl-${ISTIO_VERSION}-linux-amd64.tar.gz" -o istioctl.tar.gz
    tar -xzf istioctl.tar.gz
    chmod +x istioctl
    ./istioctl install -f /manifests/istio-operator.yml -y
    {{- if .Values.istio.ingressgatewayEnabled }}
    kubectl apply -f /manifests/istio-default-gateway.yml
    {{- end }}
    {{- if .Values.istio.prometheusScrape }}
    kubectl apply -f /manifests/istio-scrapping-sm.yml
    {{- end }}
    {{- if .Values.istio.cpuLimitsDisabled }}
    kubectl patch -f /manifests/istio-sidecar-injector.yaml --patch-file /manifests/istio-sidecar-injector.yaml
    {{- end }}